import { expect, test } from "vitest";
import { Board, King, Piece, STARTING_BOARD } from "./pieces";
import { Doc, Id } from "../../convex/_generated/dataModel";
import { isQueenSideCastlingPossible } from "./is-queen-side-castling-possible";

const game: Doc<"games"> = {
  _id: "" as Id<"games">,
  _creationTime: 0,
  board: STARTING_BOARD,
  players: [],
  turn: 1,
  state: "playing",
  history: [],
};

test("starting position", () => {
  expect(isQueenSideCastlingPossible(game, "k")).toEqual(false);
  expect(isQueenSideCastlingPossible(game, "K")).toEqual(false);
});

const valid_cases: [Board, King][] = [
  [
    [
      ["r1", "", "", "k", "", "", "", "r2"],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["R1", "", "", "K", "", "", "", "R2"],
    ],
    "k",
  ],
  [
    [
      ["r1", "", "", "k", "", "", "", "r2"],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["R1", "", "", "K", "", "", "", "R2"],
    ],
    "K",
  ],
  [
    [
      ["r1", "n1", "b1", "k", "", "", "", "r2"],
      ["p1", "p2", "p3", "p4", "p5", "p6", "p7", "p8"],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["P1", "P2", "P3", "P4", "P5", "P6", "P7", "P8"],
      ["R1", "N1", "B1", "K", "Q", "B2", "N2", "R2"],
    ],
    "k",
  ],
  [
    [
      ["r1", "n1", "b1", "k", "q", "b2", "n2", "r2"],
      ["p1", "p2", "p3", "p4", "p5", "p6", "p7", "p8"],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["P1", "P2", "P3", "P4", "P5", "P6", "P7", "P8"],
      ["R1", "N1", "B1", "K", "", "", "", "R2"],
    ],
    "K",
  ],
];

test.each(valid_cases)("valid case", (board, king) => {
  expect(isQueenSideCastlingPossible({ ...game, board }, king)).toEqual(true);
});

const invalid_cases: [
  Board,
  King,
  { piece: Piece; from: [number, number]; to: [number, number] }[],
][] = [
  [
    [
      ["r1", "", "", "k", "q", "", "", "r2"],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["R1", "", "", "K", "", "", "", "R2"],
    ],
    "k",
    [],
  ],
  [
    [
      ["r1", "", "", "k", "", "", "", "r2"],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", "R2"],
      ["R1", "", "", "K", "", "", "", ""],
    ],
    "K",
    [{ piece: "R2", from: [7, 7], to: [6, 7] }],
  ],
  [
    [
      ["r1", "", "", "k", "", "", "", ""],
      ["", "", "", "", "", "", "", "r2"],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "", "", "", "", ""],
      ["R1", "", "", "K", "", "", "", "R2"],
    ],
    "k",
    [{ piece: "r2", from: [0, 7], to: [1, 7] }],
  ],
];

test.each(invalid_cases)("invalid case", (board, king, history) => {
  expect(
    isQueenSideCastlingPossible({ ...game, board, history }, king)
  ).toEqual(false);
});
